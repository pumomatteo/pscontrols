{"version":3,"file":"speechRecognizer.js","sources":["../../../../src/ui/controls/speechRecognizer.ts"],"sourcesContent":["import { ControlTypeEnum, createButton, div, IconClassicLight, puma, SpeechRecognizerOptions } from \"../vr\";\nimport { VrControl, VrControlsEvent } from \"../common\";\nimport { Button } from \"./button\";\n\ndeclare var SpeechRecognition: any;\ndeclare var webkitSpeechRecognition: any;\ndeclare var SpeechGrammarList: any;\ndeclare var webkitSpeechGrammarList: any;\n\n//#region Control\nexport class SpeechRecognizer extends VrControl\n{\n\t//#region Variables\n\tprivate _btnMicrophone: Button;\n\tprivate _recognition: any;\n\tprivate _allTextFromStart: string;\n\t//#endregion\n\n\tconstructor(element: HTMLElement, options?: SpeechRecognizerOptions | null)\n\t{\n\t\t//#region Options\n\t\tif (options == null)\n\t\t\toptions = new SpeechRecognizerOptions();\n\n\t\tif (options.continuous == null) options.continuous = true;\n\t\tif (options.interimResults == null) options.interimResults = true;\n\t\tif (options.language == null) options.language = \"it-IT\";\n\t\tif (options.maxAlternatives == null) options.maxAlternatives = 1;\n\t\tif (options.size == null) options.size = 14;\n\t\tif (options.stopAtClick == null) options.stopAtClick = false;\n\t\t//#endregion\n\n\t\tsuper(element, options, ControlTypeEnum.SpeechRecognizer);\n\n\t\t//#region Microphone\n\t\tthis._btnMicrophone = createButton({\n\t\t\ticon: IconClassicLight.Microphone,\n\t\t\tcss: \"border: none; background: none; border-radius: 20px; font-size: \" + options.size + \"px;\",\n\t\t\ttag: \"deactivated\",\n\t\t\ticonSettings: { fontSize: options.size },\n\t\t\tonClick: (e) =>\n\t\t\t{\n\t\t\t\tif (!this.enabled())\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (options!.onClick != null)\n\t\t\t\t{\n\t\t\t\t\tlet clickEvent = new SpeechRecognizerClickEvent();\n\t\t\t\t\tclickEvent.sender = this;\n\t\t\t\t\toptions!.onClick(clickEvent);\n\n\t\t\t\t\tif (clickEvent.isDefaultPrevented())\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (e.sender.tag() == \"deactivated\")\n\t\t\t\t\tthis.start();\n\t\t\t\telse\n\t\t\t\t\tthis.stop();\n\t\t\t}\n\t\t}, this.element());\n\n\t\tdiv(this._btnMicrophone.element(), { class: \"speechRecognizerDivPulse\" }, true)\n\t\t//#endregion\n\n\t\tif (!('webkitSpeechRecognition' in window) && !('speechRecognition' in window))\n\t\t{\n\t\t\t//#region Browser not supported\n\t\t\tthis._btnMicrophone.disable();\n\t\t\tthis._btnMicrophone.icon(IconClassicLight.MicrophoneSlash);\n\t\t\tthis._btnMicrophone.tooltip(\"Il browser non supporta questa funzionalitÃ \");\n\t\t\t//#endregion\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlet speechRecognition = webkitSpeechRecognition || SpeechRecognition;\n\t\t\tlet speechGrammarList = webkitSpeechGrammarList || SpeechGrammarList;\n\n\t\t\tthis._recognition = new speechRecognition();\n\t\t\tthis._recognition.continuous = options.continuous;\n\t\t\tthis._recognition.interimResults = options.interimResults;\n\t\t\tthis._recognition.lang = options.language;\n\t\t\tthis._recognition.maxAlternatives = options.maxAlternatives;\n\n\t\t\t//#region Grammar\n\t\t\tif (options.grammars != null && options.grammars.length > 0)\n\t\t\t{\n\t\t\t\tlet speechRecognitionList = new speechGrammarList();\n\t\t\t\tfor (let grammar of options.grammars)\n\t\t\t\t\tspeechRecognitionList.addFromString(grammar, 1);\n\t\t\t\tthis._recognition.grammars = speechRecognitionList;\n\t\t\t}\n\t\t\t//#endregion\n\n\t\t\t//#region Events\n\t\t\tthis._recognition.onresult = (e: any) =>\n\t\t\t{\n\t\t\t\tlet interimResults = \"\";\n\t\t\t\tlet finalResults = \"\";\n\n\t\t\t\tfor (var i = e.resultIndex; i < e.results.length; ++i)\n\t\t\t\t{\n\t\t\t\t\tif (e.results[i].isFinal)\n\t\t\t\t\t{\n\t\t\t\t\t\tfinalResults += e.results[i][0].transcript;\n\t\t\t\t\t\tthis._allTextFromStart += e.results[i][0].transcript;\n\t\t\t\t\t} else\n\t\t\t\t\t{\n\t\t\t\t\t\tinterimResults += e.results[i][0].transcript;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (options!.onResult != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerResultEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\tevent.results = e.results;\n\t\t\t\t\tevent.resultIndex = e.resultIndex;\n\t\t\t\t\tevent.interimResults = interimResults;\n\t\t\t\t\tevent.finalResults = finalResults;\n\t\t\t\t\tevent.allTextFromStart = this._allTextFromStart;\n\t\t\t\t\toptions!.onResult(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onnomatch = () =>\n\t\t\t{\n\t\t\t\tif (options!.onNoMatch != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerNoMatchEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onNoMatch(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onerror = (e: any) =>\n\t\t\t{\n\t\t\t\tif (options!.onError != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerErrorEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\tevent.error = e.error;\n\t\t\t\t\tevent.message = e.message;\n\t\t\t\t\toptions!.onError(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onstart = () =>\n\t\t\t{\n\t\t\t\tif (options!.onStart != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerStartEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onStart(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onend = () =>\n\t\t\t{\n\t\t\t\tlet options = this.getOptions();\n\t\t\t\tif (this._btnMicrophone.tag() == \"activated\" && options.stopAtClick)\n\t\t\t\t{\n\t\t\t\t\tthis._recognition.start();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._allTextFromStart = \"\";\n\t\t\t\tthis._btnMicrophone.tag(\"deactivated\");\n\t\t\t\tpuma(this._btnMicrophone.element()).removeClass(\"microphoneActive\");\n\n\t\t\t\tif (options!.onEnd != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerEndEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onEnd(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onspeechstart = () =>\n\t\t\t{\n\t\t\t\tif (options!.onSpeechStart != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerSpeechStartEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onSpeechStart(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onspeechend = () =>\n\t\t\t{\n\t\t\t\tif (options!.onSpeechEnd != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerSpeechEndEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onSpeechEnd(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onaudiostart = () =>\n\t\t\t{\n\t\t\t\tif (options!.onAudioStart != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerAudioStartEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onAudioStart(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onaudioend = () =>\n\t\t\t{\n\t\t\t\tif (options!.onAudioEnd != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerAudioEndEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onAudioEnd(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onsoundstart = () =>\n\t\t\t{\n\t\t\t\tif (options!.onSoundStart != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerSoundStartEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onSoundStart(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._recognition.onsoundend = () =>\n\t\t\t{\n\t\t\t\tif (options!.onSoundEnd != null)\n\t\t\t\t{\n\t\t\t\t\tlet event = new SpeechRecognizerSoundEndEvent();\n\t\t\t\t\tevent.sender = this;\n\t\t\t\t\toptions!.onSoundEnd(event);\n\t\t\t\t}\n\t\t\t}\n\t\t\t//#endregion\n\t\t}\n\t}\n\n\t//#region Methods\n\tstart()\n\t{\n\t\tthis._allTextFromStart = \"\";\n\t\tthis._btnMicrophone.tag(\"activated\");\n\t\tpuma(this._btnMicrophone.element()).addClass(\"microphoneActive\");\n\t\tthis._recognition.start();\n\t}\n\n\tstop()\n\t{\n\t\tthis._allTextFromStart = \"\";\n\t\tthis._btnMicrophone.tag(\"deactivated\");\n\t\tpuma(this._btnMicrophone.element()).removeClass(\"microphoneActive\");\n\t\tthis._recognition.stop();\n\t}\n\n\tisRecording()\n\t{\n\t\treturn this._btnMicrophone.tag() == \"activated\";\n\t}\n\n\tgetOptions()\n\t{\n\t\treturn this.options<SpeechRecognizerOptions>();\n\t}\n\t//#endregion\n\n\t//#region Overrides\n\tenable(): void\n\t{\n\t\tsuper.enable();\n\t}\n\n\tdisable(): void\n\t{\n\t\tsuper.disable();\n\t\tthis.stop();\n\t}\n}\n//#endregion\n\n//#region Classes\nexport class SpeechRecognizerEvent extends VrControlsEvent\n{\n\tsender: SpeechRecognizer;\n}\n\nexport class SpeechRecognizerNoMatchEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerClickEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerErrorEvent extends SpeechRecognizerEvent\n{\n\terror: string;\n\tmessage: string;\n}\n\nexport class SpeechRecognizerResultEvent extends SpeechRecognizerEvent\n{\n\tresults: any;\n\tresultIndex: number;\n\tinterimResults: string;\n\tfinalResults: string;\n\tallTextFromStart: string;\n}\n\nexport class SpeechRecognizerStartEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerEndEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerSpeechStartEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerSpeechEndEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerAudioStartEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerAudioEndEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerSoundStartEvent extends SpeechRecognizerEvent\n{ }\n\nexport class SpeechRecognizerSoundEndEvent extends SpeechRecognizerEvent\n{ }\n//#endregion"],"names":["options"],"mappings":"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"}